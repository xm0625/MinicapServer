<html>
<head>
    <title>Phone</title>

    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />

    <style>
        body{
            margin: 0;
        }

        .leftToolBox {
            width: 12%;
            position: relative;
            float: left;
        }

        .rightCanvasBox {
            width: 88%;
            position: relative;
            float: left;
        }

        .rightCanvasBox canvas {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div class="leftToolBox">&nbsp;</div>
<div class="rightCanvasBox">
    <canvas id="canvas" style="border: 1px solid red;"></canvas>
</div>
<div style="clear: both;"></div>

<script type="text/javascript" charset="utf-8" src="./jquery.min.js"></script>
<script>
    /*jshint browser:true*/

    var BLANK_IMG =
        'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';

    var canvas = document.getElementById('canvas');
    var g = canvas.getContext('2d');

    var minicapWs = new WebSocket('ws://192.168.9.6:9002/minicap');
    minicapWs.binaryType = 'blob';

    minicapWs.onclose = function () {
        console.log('onclose', arguments);
    };

    minicapWs.onerror = function () {
        console.log('onerror', arguments);
    };

    minicapWs.onmessage = function (message) {
        var blob = new Blob([message.data], {type: 'image/jpeg'});
        var URL = window.URL || window.webkitURL;
        var img = new Image();
        img.onload = function () {
            console.log(img.width, img.height);
            var widthRatio = canvas.width / img.width;
            var heightRatio = canvas.height / img.height;
            var ratio;
            if(widthRatio < heightRatio){
                ratio = widthRatio;
                g.drawImage(img, 0, 0, img.width*ratio, img.height*ratio);
            }else{
                ratio = heightRatio;
                var realWidth = img.width*ratio;
                g.drawImage(img, canvas.width - realWidth, 0, realWidth, img.height*ratio);
            }
            img.onload = null;
            img.src = BLANK_IMG;
            img = null;
            u = null;
            blob = null;
        };
        var u = URL.createObjectURL(blob);
        img.src = u;
    };

    minicapWs.onopen = function () {
        console.log('onopen', arguments);
        minicapWs.send('1920x1080/0');
    };

    function client() {
        if (window.innerHeight !== undefined) {
            return {
                "width": window.innerWidth,
                "height": window.innerHeight
            }
        } else if (document.compatMode === "CSS1Compat") {
            return {
                "width": document.documentElement.clientWidth,
                "height": document.documentElement.clientHeight
            }
        } else {
            return {
                "width": document.body.clientWidth,
                "height": document.body.clientHeight
            }
        }
    }

    window.onresize = function () {
        console.log("onResize");
        setTimeout(window.location.reload, 1000);
    };

    $(document).ready(function(){
        $("#canvas").css("height", client().height+"px");
        canvas.height = client().height;
        canvas.width = parseInt($("#canvas").css("width"));

        document.documentElement.style.overflow='hidden';
        document.body.style.overflow='hidden';
    });


    var minitouchWs = new WebSocket('ws://192.168.9.6:9002/minitouch');

</script>

</body>
</html>
