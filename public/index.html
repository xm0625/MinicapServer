<!doctype html>
<head>
    <title>Phone</title>

    <style>
        .leftToolBox {
            width: 12%;
            position: relative;
            float: left;
        }

        .rightCanvasBox {
            width: 88%;
            position: relative;
            float: left;
        }

        .rightCanvasBox canvas {
            width: 100%;
        }
    </style>
</head>
<body>
<div class="leftToolBox">

</div>
<div class="rightCanvasBox">
    <canvas id="canvas" style="border: 1px solid red;"></canvas>
</div>
<div style="clear: both;"></div>
<script>
    /*jshint browser:true*/

    var BLANK_IMG =
        'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';

    var canvas = document.getElementById('canvas');
    var g = canvas.getContext('2d');

    var ws = new WebSocket('ws://' + window.location.host, 'minicap');
    ws.binaryType = 'blob';

    ws.onclose = function () {
        console.log('onclose', arguments);
    };

    ws.onerror = function () {
        console.log('onerror', arguments);
    };

    ws.onmessage = function (message) {
        var blob = new Blob([message.data], {type: 'image/jpeg'});
        var URL = window.URL || window.webkitURL;
        var img = new Image();
        img.onload = function () {
            console.log(img.width, img.height);
            var widthRatio = canvas.width / img.width;
            var heightRatio = canvas.height / img.height;
            var ratio;
            if(widthRatio < heightRatio){
                ratio = widthRatio;
                g.drawImage(img, 0, 0, img.width*ratio, img.height*ratio);
            }else{
                ratio = heightRatio;
                var realWidth = img.width*ratio;
                g.drawImage(img, canvas.width - realWidth, 0, realWidth, img.height*ratio);
            }
            img.onload = null;
            img.src = BLANK_IMG;
            img = null;
            u = null;
            blob = null;
        };
        var u = URL.createObjectURL(blob);
        img.src = u;
    };

    ws.onopen = function () {
        console.log('onopen', arguments);
        ws.send('1920x1080/0');
    };

    function client() {
        if (window.innerHeight !== undefined) {
            return {
                "width": window.innerWidth,
                "height": window.innerHeight
            }
        } else if (document.compatMode === "CSS1Compat") {
            return {
                "width": document.documentElement.clientWidth,
                "height": document.documentElement.clientHeight
            }
        } else {
            return {
                "width": document.body.clientWidth,
                "height": document.body.clientHeight
            }
        }
    }

    window.onload = function () {
        canvas.height = client().height;
    };

    window.onresize = function () {
        setTimeout(window.location.reload, 1000);
    };

</script>

</body>
